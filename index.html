<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Calculadora Hipotecaria CRC y aportes</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-2:#06b6d4;--danger:#ef4444;--warning:#f59e0b;--border:#1f2937;--gray:#9ca3af}
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif; -webkit-text-size-adjust: 100%; -webkit-font-smoothing: antialiased}
    h1,h2{margin:0 0 .5rem} a{color:var(--accent-2)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .wrap.grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .span-7{grid-column:span 7} .span-5{grid-column:span 5} .span-12{grid-column:span 12}
    label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb;outline:none; -webkit-appearance:none}
    input[type="date"]{padding:10px}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    select{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" fill="%2394a3b8"><path d="M1 1l5 5 5-5"/></svg>'); background-repeat:no-repeat; background-position:right 10px center; padding-right:28px}
    .grid{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .btn{cursor:pointer;font-weight:600} .btn-primary{background:var(--accent);border-color:transparent;color:#052e16}
    .btn-secondary{background:#0b1220} .btn-danger{background:var(--danger);border-color:transparent}
    .btn-pill{border-radius:999px;padding:10px 16px}
    .btn-xs{padding:0;width:28px;height:28px;line-height:26px;text-align:center;border-radius:6px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .table-wrap{overflow:auto;max-height:420px;border-radius:10px;border:1px solid var(--border); -webkit-overflow-scrolling: touch}
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap}
    th:nth-child(2), td:nth-child(2){text-align:center} th:first-child, td:first-child{text-align:center}
    th{position:sticky;top:0;background:#0b1220}
    .note{color:var(--muted);font-size:.9rem}
    .pill{display:inline-block;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .stat{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center} .stat b{font-size:1.05rem}
    .ok{color:var(--accent)} .warn{color:var(--warning)} .bad{color:var(--danger)} .gray{color:var(--gray)}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .help{font-size:.85rem;color:var(--muted)}
    .tag{display:inline-block;background:#0b1220;border:1px solid var(--border);border-radius:8px;padding:4px 8px;margin-right:6px}
    .mini-table{overflow:auto;border:1px solid var(--border);border-radius:10px; -webkit-overflow-scrolling: touch}
    .mini-table table{table-layout:fixed; width:640px; min-width:640px}
    .mini-table th:nth-child(1), .mini-table td:nth-child(1){width:40px;text-align:center}
    .mini-table th:nth-child(2), .mini-table td:nth-child(2){width:140px;text-align:center}
    .mini-table th:nth-child(3), .mini-table td:nth-child(3){width:160px}
    .mini-table th:nth-child(4), .mini-table td:nth-child(4){width:140px;text-align:center}
    .mini-table th:nth-child(5), .mini-table td:nth-child(5){width:60px;text-align:center}
    .subhead{font-size:.85rem;letter-spacing:.06em;text-transform:uppercase;color:var(--gray);margin:6px 0 2px}
    #curveWrap{border:1px solid var(--border);border-radius:10px;padding:8px;margin-top:6px; position:relative}
    canvas{display:block;width:100%;height:160px}
    .legend{display:flex;gap:10px;align-items:center;font-size:.85rem;color:var(--muted)}
    .leg{display:inline-flex;align-items:center;gap:6px}
    .boxG{width:14px;height:3px;background:var(--accent);display:inline-block;border-radius:2px}
    .boxB{width:14px;height:3px;background:var(--gray);display:inline-block;border-radius:2px}
    .chart-tip{position:absolute;pointer-events:none;background:#0b1220;border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:.85rem;color:var(--text);box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .chart-tip b{display:block}
    .muted{color:var(--muted)}

    /* ===== Responsive ===== */
    @media (max-width: 980px){
      .wrap{padding:16px}
      .span-7, .span-5, .span-12{grid-column:span 12}
      .row{grid-template-columns:1fr}
      .row3{grid-template-columns:1fr 1fr}
      .row4{grid-template-columns:1fr 1fr}
      table{min-width:740px}
      th{position:static} /* Safari iOS: sticky + overflow puede fallar */
      .btn-xs{width:28px}
    }
    @media (max-width: 640px){
      .row3{grid-template-columns:1fr}
      .mini-table table{min-width:440px}
      table{min-width:680px}
    }
  </style>
</head>
<body>
  <div class="wrap grid">
    <header class="card span-12">
      <h1>Calculadora Hipotecaria — Aportes extra.</h1>
      <div class="note">Interés <b>mensual vencido M/VEN</b> (anual/12). Penalidad de prepago se <b>descuenta del aporte</b> (no reduce saldo). Con aportes, el <b>plazo se reduce</b>; en cambios de tasa, la cuota se recalcula preservando meses ahorrados.</div>
    </header>

    <section class="card span-7 grid">
      <h2>Parámetros</h2>
      <div class="row">
        <div>
          <label>Monto del préstamo</label>
          <input id="principal" type="number" inputmode="decimal" step="100000" min="0" autocomplete="off">
        </div>
        <div>
          <label>Cuota inicial (calculada)</label>
          <input id="monthlyPayment" type="number" inputmode="decimal" step="0.01" min="0" autocomplete="off" readonly>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Fecha de inicio</label>
          <input id="startDate" type="date" inputmode="numeric" placeholder="AAAA-MM-DD" autocomplete="off">
        </div>
        <div>
          <label>Plazo original (meses)</label>
          <input id="origTerm" type="number" min="1" step="1" inputmode="numeric" autocomplete="off">
        </div>
      </div>

      <div class="hr"></div>
      <h3>Tasas por periodo</h3>
      <div class="note">Agregue al menos un periodo de tasa (inicio, tasa anual y fin opcional (vacío= hasta final de plazo</div>
      <div id="rates"></div>
      <div class="flex">
        <button id="addRate" class="btn btn-secondary btn-pill">+ Agregar periodo</button>
      </div>

      <div class="hr"></div>
      <h3>Penalización sobre aportes extraordinarios</h3>
      <div class="row">
        <div>
          <label>Porcentaje (%)</label>
          <input id="penaltyPct" type="number" inputmode="decimal" step="0.1" min="0" autocomplete="off">
        </div>
        <div>
          <label>Vigencia (meses desde inicio)</label>
          <input id="penaltyMonths" type="number" step="1" min="0" inputmode="numeric" autocomplete="off">
        </div>
      </div>

      <div class="hr"></div>
      <h3>Aportes extraordinarios</h3>
      <div class="note">Podés combinar <span class="tag">puntuales</span> y <span class="tag">mensuales desde fecha</span></div>

      <h4>Puntuales</h4>
      <div id="extrasList"></div>
      <div class="row4">
        <div><label>Fecha</label><input id="exDate" type="date" inputmode="numeric" placeholder="AAAA-MM-DD"></div>
        <div><label>Monto</label><input id="exAmount" type="number" inputmode="numeric" step="10000" min="0"></div>
        <div>
          <label>Aplicar a</label>
          <select id="exEffect">
            <option value="plazo" selected>Reducir plazo</option>
            <option value="cuota">Reducir cuota</option>
          </select>
        </div>
        <div><label>&nbsp;</label><button id="addExtra" class="btn btn-secondary btn-pill">+ Agregar</button></div>
      </div>

      <h4>Mensuales desde fecha</h4>
      <div class="row4">
        <div><label>Activar</label>
          <select id="recurOn">
            <option value="no" selected>No</option>
            <option value="si">Sí</option>
          </select>
        </div>
        <div><label>Desde</label><input id="recurStart" type="date" inputmode="numeric" placeholder="AAAA-MM-DD"></div>
        <div><label>Monto mensual</label><input id="recurAmount" type="number" inputmode="numeric" step="10000" min="0"></div>
        <div>
          <label>Aplicar a</label>
          <select id="recurEffect">
            <option value="plazo" selected>Reducir plazo</option>
            <option value="cuota">Reducir cuota</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Meses a aplicar (opcional)</label>
          <input id="recurMonths" type="number" step="1" min="0" placeholder="vacío = hasta el fin del préstamo" inputmode="numeric">
        </div>
        <div></div>
      </div>

      <div class="hr"></div>
      <div class="flex">
        <button id="calc" class="btn btn-primary btn-pill">Calcular</button>
        <button id="exportCsv" class="btn btn-secondary btn-pill">Exportar CSV</button>
        <span id="msg" class="note"></span>
      </div>
    </section>

    <aside class="card span-5 grid">
      <h2>Resumen</h2>

      <div class="hr"></div>
      <div class="subhead">Base (sin aportes)</div>
      <div id="summaryBase" class="grid"></div>

      <div class="hr"></div>
      <div class="subhead">Con aportes</div>
      <div id="summaryAporte" class="grid"></div>

      <div class="hr"></div>
      <div class="subhead">Diferencias</div>
      <div id="summaryDiff" class="grid"></div>

      <div class="hr"></div>
      <div class="subhead">Curva de amortización</div>
      <div id="curveWrap">
        <canvas id="miniChart" width="560" height="160"></canvas>
        <div class="legend">
          <span class="leg"><i class="boxB"></i> Base</span>
          <span class="leg"><i class="boxG"></i> Con aportes</span>
        </div>
        <div id="chartTip" class="chart-tip" style="display:none"></div>
      </div>
    </aside>

    <section class="card span-12 grid">
      <h2>Cronograma (con aportes)</h2>
      <div class="table-wrap">
        <table id="sched">
          <colgroup>
            <col style="width:80px">
            <col style="width:120px">
            <col style="width:60px">
            <col style="width:120px">
            <col style="width:120px">
            <col style="width:120px">
            <col style="width:140px">
            <col style="width:120px">
            <col style="width:120px">
            <col style="width:120px">
          </colgroup>
          <thead>
            <tr>
              <th>Período</th>
              <th>Fecha</th>
              <th>Días</th>
              <th>Tasa anual periodo</th>
              <th>Interés</th>
              <th>Amortización</th>
              <th>Cuota</th>
              <th>Penalidad</th>
              <th>Aportes extra</th>
              <th>Saldo final</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note">La penalidad se descuenta del aporte: si aportás ₡1 000 000 y la penalidad es 3% (=₡30 000), solo ₡970 000 van a capital.</div>
    </section>
  </div>

<script>
(function(){
  // --------- Utilidad: soporte de fecha en Safari ---------
  function supportsDateInput(){
    var i=document.createElement('input');
    i.setAttribute('type','date');
    var notADateValue = 'not-a-date';
    i.setAttribute('value', notADateValue);
    return (i.value !== notADateValue);
  }
  function ensureDateInputs(){
    if (supportsDateInput()) return;
    var dts = document.querySelectorAll('input[type="date"]');
    for (var k=0;k<dts.length;k++){
      var el = dts[k];
      el.setAttribute('type','text');
      el.setAttribute('placeholder','AAAA-MM-DD');
      el.setAttribute('pattern','^\\d{4}-\\d{2}-\\d{2}$');
    }
  }

  // ---------- Helpers tamaño canvas ----------
  function canvasDims(c){
    var wrap = document.getElementById('curveWrap');
    var cs = getComputedStyle(c);
    var w = c.clientWidth || (wrap ? wrap.clientWidth - 16 : 0) || parseInt(cs.width) || 560;
    var h = c.clientHeight || parseInt(cs.height) || 160;
    return {w:w, h:h};
  }

  // ---------- Fechas ----------
  function toISO(d){ return d.toISOString().slice(0,10); }
  function fromISO(s){ var A=s.split('-'); return new Date(Number(A[0]),Number(A[1])-1,Number(A[2])); }
  function addMonths(d, months){
    var dt = new Date(d.getTime()), day = dt.getDate();
    dt.setDate(1); dt.setMonth(dt.getMonth()+months);
    var lastDay = new Date(dt.getFullYear(), dt.getMonth()+1, 0).getDate();
    dt.setDate(Math.min(day,lastDay)); return dt;
  }
  function daysBetween(a,b){ return Math.round((b-a)/(1000*60*60*24)); }

  // ---------- Tasas ----------
  function normalizeRatePeriods(periods){
    var rps = periods.map(function(p){ return {
      start: (p.start instanceof Date) ? p.start : fromISO(p.start),
      end: p.end ? ((p.end instanceof Date)? p.end : fromISO(p.end)) : null,
      annual_rate: Number(p.annual_rate)
    }; }).sort(function(a,b){ return a.start - b.start; });
    return rps;
  }
  function rateAt(date, periods){
    var norm = normalizeRatePeriods(periods);
    if (!norm.length) return 0;
    for (var i=0;i<norm.length;i++){
      var rp = norm[i];
      var endEx = rp.end ? new Date(rp.end.getFullYear(), rp.end.getMonth(), rp.end.getDate()+1) : null;
      if (rp.start <= date && (!endEx || date < endEx)) return rp.annual_rate;
    }
    return norm[0].annual_rate;
  }

  // ---------- Penalización ----------
  function penaltyPctIfApplies(startDate, extraDate, penaltyMonths, penaltyPct){
    if (!extraDate || penaltyMonths<=0 || penaltyPct<=0) return 0;
    var cutoff = addMonths(startDate, penaltyMonths);
    return (extraDate <= cutoff) ? penaltyPct : 0.0;
  }
  function round2(n){ return Math.round((n + 1e-12)*100)/100; }

  // ---------- Aportes del mes ----------
  function monthlies(prev, due, recurCfg){
    if (!(recurCfg && recurCfg.on && recurCfg.amount>0 && recurCfg.start)) return null;
    var start = (recurCfg.start instanceof Date)? recurCfg.start : fromISO(recurCfg.start);
    if (due < start) return null;
    var monthsFromStart = (due.getFullYear()-start.getFullYear())*12 + (due.getMonth()-start.getMonth());
    if (recurCfg.months && monthsFromStart >= recurCfg.months) return null;
    var d = new Date(due.getTime()-1); // al final del mes
    return {date: d, amount: Number(recurCfg.amount), mode: (recurCfg.mode||'plazo')};
  }
  function extrasInMonth(prev, due, extraEvents, recurCfg){
    var list=[];
    // Puntuales
    for (var i=0;i<extraEvents.length;i++){
      var ev = extraEvents[i]; if (!ev) continue;
      var d = (ev.date instanceof Date)? ev.date : fromISO(ev.date);
      var a = Number(ev.amount)||0;
      if (a>0 && d>prev && d<=due) list.push({date:d, amount:a, mode:(ev.mode||'plazo')});
    }
    // Recurrente mensual
    var m = monthlies(prev,due,recurCfg);
    if (m) list.push(m);
    list.sort(function(a,b){ return a.date-b.date; });
    return list;
  }

  // ---------- N_eff (meses remanentes) ----------
  function effectiveRemainingMonths(balance, monthlyRate, payment){
    if (balance <= 1e-9) return 0;
    if (monthlyRate <= 0) return Math.ceil(balance / payment);
    var r = monthlyRate;
    var ratio = 1 - (balance * r / payment);
    if (ratio <= 1e-12) return Infinity;
    var N = - Math.log(ratio) / Math.log(1+r);
    return Math.ceil(N);
  }

  // ---------- Amortización (M/VEN) ----------
  function amortizationSchedule(opts){
    var principal = opts.principal;
    var startDate = opts.startDate;
    var ratePeriods = opts.ratePeriods;
    var extraEvents = opts.extraEvents || [];
    var recurCfg = opts.recurCfg || null;
    var penaltyPct = (typeof opts.penaltyPct==='number'?opts.penaltyPct:0.03);
    var penaltyMonths = (typeof opts.penaltyMonths==='number'?opts.penaltyMonths:36);
    var originalTermMonths = (typeof opts.originalTermMonths==='number'?opts.originalTermMonths:360);

    if (!(principal>0)) throw new Error("El monto del préstamo debe ser mayor que cero.");

    var prev = startDate;
    var due  = addMonths(startDate,1);
    var bal  = principal;
    var rows=[];
    var interestTotal=0;

    // Cuota inicial para cerrar en 'originalTermMonths' con la tasa del 1er mes
    var r0 = rateAt(prev, ratePeriods)/12;
    var currentPayment = (r0>0)
      ? bal * (r0*Math.pow(1+r0, originalTermMonths)) / (Math.pow(1+r0, originalTermMonths)-1)
      : bal / originalTermMonths;

    var targetRemaining = originalTermMonths;

    for (var i=1; i<=originalTermMonths*2; i++){
      if (bal<=1e-6) break;

      var rAnnual = rateAt(prev, ratePeriods);
      var rMonthly = rAnnual/12;

      // Cambio de tasa → ajustar cuota manteniendo meses ganados
      if (i>1){
        var rPrev = rateAt(addMonths(prev,-1), ratePeriods)/12;
        if (Math.abs(rMonthly - rPrev) > 1e-12){
          var N_eff = effectiveRemainingMonths(bal, rMonthly, currentPayment);
          targetRemaining = Math.min(targetRemaining, N_eff);
          if (!isFinite(targetRemaining) || targetRemaining<1) targetRemaining = 1;
          currentPayment = (rMonthly>0)
            ? bal * (rMonthly*Math.pow(1+rMonthly, targetRemaining)) / (Math.pow(1+rMonthly, targetRemaining)-1)
            : bal / targetRemaining;
        }
      }

      var daysInMonth = Math.max(1, daysBetween(prev, due));
      var interestThis=0, extraThis=0, penaltyThis=0;
      var cursor = prev;

      // Aportes del mes
      var monthExtras = extrasInMonth(prev, due, extraEvents, recurCfg);
      for (var j=0;j<monthExtras.length;j++){
        if (bal<=1e-6) break;
        var ev = monthExtras[j];
        var segDays = Math.max(0, daysBetween(cursor, ev.date));
        if (segDays>0){
          interestThis += bal * rMonthly * (segDays/daysInMonth);
          cursor = ev.date;
        }
        var gross = Math.min(ev.amount, bal);
        var penPct = penaltyPctIfApplies(startDate, ev.date, penaltyMonths, penaltyPct);
        var pen    = gross * penPct;
        var net    = Math.max(0, gross - pen);
        penaltyThis += pen;
        bal = Math.max(0, bal - net);
        extraThis += gross;

        // Ajustar segn efecto seleccionado: plazo o cuota
        var mode = ev.mode || 'plazo';
        if (mode === 'plazo'){
          // Recalcular meses "efectivos" tras el aporte (reducir plazo)
          var N_eff_now = effectiveRemainingMonths(bal, rMonthly, currentPayment);
          targetRemaining = Math.min(targetRemaining, N_eff_now);
          if (targetRemaining < 1) targetRemaining = 1;
        } else {
          // Reducir cuota: recalcular cuota manteniendo los meses objetivo
          var N_for_payment = Math.max(1, Math.round(targetRemaining));
          currentPayment = (rMonthly>0)
            ? bal * (rMonthly*Math.pow(1+rMonthly, N_for_payment)) / (Math.pow(1+rMonthly, N_for_payment)-1)
            : (N_for_payment>0? bal / N_for_payment : bal);
        }
      }

      // tramo restante del mes
      if (bal>1e-6){
        var segDays2 = Math.max(0, daysBetween(cursor, due));
        if (segDays2>0) interestThis += bal * rMonthly * (segDays2/daysInMonth);
      }

      // Pago del mes
      var payment = currentPayment;
      if (payment < interestThis && i < originalTermMonths*2){
        payment = interestThis; // evita amortización negativa
      }

      var principalPayment = payment - interestThis;
      if (principalPayment > bal){
        payment = interestThis + bal;
        principalPayment = bal;
      }

      var newBal = Math.max(0, bal - principalPayment);

      rows.push({
        Periodo:i, FechaPago: toISO(due),
        TasaAnualPeriodo: Number((rAnnual*100).toFixed(4)),
        Interes: round2(interestThis),
        Amortizacion: round2(principalPayment),
        Cuota: round2(payment),
        Penalidad: round2(penaltyThis),
        AportesExtra: round2(extraThis),
        SaldoFinal: round2(newBal)
      });

      interestTotal += interestThis;
      bal = newBal;
      targetRemaining = Math.max(0, targetRemaining-1);
      prev = due; due = addMonths(due,1);
    }

    var endDate = rows.length ? rows[rows.length-1].FechaPago : null;
    var total_cuotas = rows.reduce(function(s,r){return s + r.Cuota;}, 0);
    var total_extras = rows.reduce(function(s,r){return s + r.AportesExtra;}, 0);
    var total_pen    = rows.reduce(function(s,r){return s + r.Penalidad;}, 0);
    var resumen = {
      total_interes: round2(interestTotal),
      total_penalidades: round2(total_pen),
      total_aportes_bruto: round2(total_extras),
      total_aportes_neto: round2(total_extras - total_pen),
      total_pagado: round2(total_cuotas + total_extras + total_pen),
      meses: rows.length,
      fecha_finalizacion: endDate
    };
    return {rows:rows, resumen:resumen};
  }

  // ---------- UI ----------
  var allowCalc = false;
  function $(sel){ return document.querySelector(sel); }
  function fmtCRC(n){ try{ return new Intl.NumberFormat('es-CR',{style:'currency',currency:'CRC'}).format(n);}catch(e){ return '₡'+(Math.round(n).toString()); } }

  // Tasas UI
  var ratesBox;
  function rateRowTemplate(obj, i){
    var start=obj.start, end=obj.end, annual=obj.annual_rate;
    var rateStr = (typeof annual === 'number' && isFinite(annual)) ? (annual*100).toFixed(4) : '';
    var delBtn = (i===0) ? '<div></div>' : '<div><label>&nbsp;</label><button class="btn btn-danger btn-xs" data-del="'+i+'">✕</button></div>';
    var html = '';
    html += '<div class="row4" data-row="'+i+'">';
    html +=   '<div><label>Inicio</label><input type="date" class="r-start" value="'+start+'"></div>';
    html +=   '<div><label>Fin</label><input type="date" class="r-end" value="'+(end||'')+'"></div>';
    html +=   '<div><label>Tasa anual (%)</label><input type="number" class="r-rate" step="0.0001" min="0" max="100" value="'+rateStr+'"></div>';
    html +=   delBtn;
    html += '</div>';
    return html;
  }
  function initDefaultRates(){
    var startDateEl = $('#startDate');
    var startDate = (startDateEl && startDateEl.value) ? startDateEl.value : '2023-03-07';
    var s = fromISO(startDate);
    var end1 = toISO(addMonths(s,36));
    return [
      {start: startDate, end: end1, annual_rate: 0.0755},
      {start: end1, end: null, annual_rate: 0.0840}
    ];
  }
  var rateRows;
  function renderRates(){
    var html = '';
    for (var i=0;i<rateRows.length;i++){ html += rateRowTemplate(rateRows[i], i); }
    ratesBox.innerHTML = html;
  }
  function readRates(){
    var out=[];
    var rows = ratesBox.querySelectorAll('.row4');
    for (var i=0;i<rows.length;i++){
      var row = rows[i];
      var start=row.querySelector('.r-start').value;
      var end=row.querySelector('.r-end').value;
      var rate=Number(row.querySelector('.r-rate').value)/100;
      if (!start || !isFinite(rate)) continue;
      out.push({start:start, end:end||null, annual_rate: rate});
    }
    return out;
  }

  // Aportes puntuales UI
  var extras = [];
  var extrasList;
  function renderExtras(){
    if (!extras.length){
      extrasList.innerHTML = '<div class="note">Sin aportes puntuales agregados.</div>'; return;
    }
    var rows='';
    for (var i=0;i<extras.length;i++){
      var e = extras[i];
      rows += '<tr><td>'+(i+1)+'</td><td style="text-align:center">'+e.date+'</td><td>'+fmtCRC(e.amount)+'</td><td><button data-del="'+i+'" class="btn btn-danger btn-xs">✕</button></td></tr>';
    }
    var html='';
    html += '<div class="mini-table">';
    html +=   '<table>';
    html +=     '<thead><tr><th>#</th><th>Fecha</th><th>Monto</th><th>✕</th></tr></thead>';
    html +=     '<tbody>'+rows+'</tbody>';
    html +=   '</table>';
    html += '</div>';
    extrasList.innerHTML = html;
  }

  // Restricción de entradas numéricas
  function restrictNumericInput(el){
    el.addEventListener('keydown', function(ev){
      var invalid = ['e','E','+','-'];
      if (invalid.indexOf(ev.key)>=0) ev.preventDefault();
    });
    el.addEventListener('input', function(){ el.value = el.value.replace(/,/g,'').replace(/\s+/g,''); });
  }

  // Lectura de inputs
  function readInputs(){
    var principal = Number(document.querySelector('#principal').value);
    var sd = document.querySelector('#startDate').value;
    if (!sd || !/^\d{4}-\d{2}-\d{2}$/.test(sd)){ throw new Error('Fecha de inicio inválida. Use AAAA-MM-DD.'); }
    var startDate = fromISO(sd);
    var origTerm = Number(document.querySelector('#origTerm').value);
    if (!(origTerm>0)){ throw new Error('Plazo original inválido.'); }
    var penaltyPct = Number(document.querySelector('#penaltyPct').value)/100;
    var penaltyMonths = Number(document.querySelector('#penaltyMonths').value)||0;
    var recurOn = document.querySelector('#recurOn').value==='si';
    var recurStartStr = document.querySelector('#recurStart').value;
    var recurAmount = Number(document.querySelector('#recurAmount').value)||0;
    var recurEffect = (document.querySelector('#recurEffect') && document.querySelector('#recurEffect').value) || 'plazo';
    var recurMonths = Number(document.querySelector('#recurMonths').value)||null;
    var ratePeriods = readRates();
    var recur = (recurOn && recurAmount>0 && recurStartStr) ? {on:true, amount:recurAmount, start:recurStartStr, months:recurMonths, mode:recurEffect} : null;

    if (!(principal>0)) throw new Error('El monto del préstamo debe ser mayor que cero.');

    return { principal:principal, startDate:startDate, origTerm:origTerm, penaltyPct:penaltyPct, penaltyMonths:penaltyMonths, extras:extras, recur:recur, ratePeriods:ratePeriods };
  }

  // Resúmenes
  function summarizeBase(id, sum){
    var el=document.querySelector(id);
    if (!sum){ el.innerHTML=''; return; }
    el.innerHTML =
      '<div class="stat"><span class="pill">Total interés</span> <b>'+fmtCRC(sum.total_interes)+'</b></div>'+
      '<div class="stat"><span class="pill">Total pagado</span> <b>'+fmtCRC(sum.total_pagado)+'</b></div>'+
      '<div class="stat"><span class="pill">Meses</span> <b>'+sum.meses+'</b></div>'+
      '<div class="stat"><span class="pill">Fecha fin</span> <b>'+(sum.fecha_finalizacion||'-')+'</b></div>';
  }
  function summarizeAporte(id, sum){
    var el=document.querySelector(id);
    if (!sum){ el.innerHTML=''; return; }
    var penCls = (sum.total_penalidades>0)?'bad':'';
    el.innerHTML =
      '<div class="stat"><span class="pill">Total interés</span> <b>'+fmtCRC(sum.total_interes)+'</b></div>'+
      '<div class="stat"><span class="pill">Penalidades</span> <b class="'+penCls+'">'+fmtCRC(sum.total_penalidades)+'</b></div>'+
      '<div class="stat"><span class="pill">Total aportes bruto</span> <b>'+fmtCRC(sum.total_aportes_bruto)+'</b></div>'+
      '<div class="stat"><span class="pill">Total aportes neto</span> <b>'+fmtCRC(sum.total_aportes_neto)+'</b></div>'+
      '<div class="stat"><span class="pill">Total pagado</span> <b>'+fmtCRC(sum.total_pagado)+'</b></div>'+
      '<div class="stat"><span class="pill">Meses</span> <b>'+sum.meses+'</b></div>'+
      '<div class="stat"><span class="pill">Fecha fin</span> <b>'+(sum.fecha_finalizacion||'-')+'</b></div>';
  }
  function summarizeDiff(base, aporte){
    var el = document.querySelector('#summaryDiff');
    if (!base || !aporte){ el.innerHTML=''; return; }
    var ahorroBruto = base.total_interes - aporte.total_interes;
    var penalPagadas = aporte.total_penalidades;
    var ahorroNeto  = ahorroBruto - penalPagadas;
    var mesesLess   = base.meses - aporte.meses;
    var abCls = (ahorroBruto>0)?'ok':'';
    var penCls = (penalPagadas>0)?'bad':'';
    var netCls = (ahorroNeto>=0)?'ok':'bad';
    el.innerHTML =
      '<div class="stat"><span class="pill">Ahorro bruto interés</span> <b class="'+abCls+'">'+fmtCRC(ahorroBruto)+'</b></div>'+
      '<div class="stat"><span class="pill">Penalidades pagadas (aportes)</span> <b class="'+penCls+'">'+fmtCRC(penalPagadas)+'</b></div>'+
      '<div class="stat"><span class="pill">Ahorro neto (– penal.)</span> <b class="'+netCls+'">'+fmtCRC(ahorroNeto)+'</b></div>'+
      '<div class="stat"><span class="pill">Reducción de meses</span> <b class="'+(mesesLess>=0?'ok':'warn')+'">'+mesesLess+'</b></div>';
  }

  // Cronograma
  function renderSchedule(rows){
    var tb = document.querySelector('#sched tbody');
    var html='';
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      html += '<tr>'+
        '<td>'+r.Periodo+'</td><td>'+r.FechaPago+'</td><td></td>'+
        '<td>'+r.TasaAnualPeriodo.toFixed(4)+'%</td>'+
        '<td>'+fmtCRC(r.Interes)+'</td><td>'+fmtCRC(r.Amortizacion)+'</td>'+
        '<td>'+fmtCRC(r.Cuota)+'</td><td>'+fmtCRC(r.Penalidad)+'</td>'+
        '<td>'+fmtCRC(r.AportesExtra)+'</td><td>'+fmtCRC(r.SaldoFinal)+'</td>'+
      '</tr>';
    }
    tb.innerHTML = html;
  }

  // --------- Mini chart (Canvas) con tooltips ---------
  var miniChartState = { data:null, hoverIndex:null };
  function curveDataYearly(rows, startDate, principal){
    var map = {}; // objeto simple p/ compat
    var y0 = startDate.getFullYear();
    map[y0] = principal;
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      var y = Number(r.FechaPago.slice(0,4));
      map[y] = r.SaldoFinal;
      if (r.SaldoFinal <= 1e-6) break;
    }
    var years = Object.keys(map).map(function(k){return Number(k);}).sort(function(a,b){return a-b;});
    var balances = years.map(function(y){ return map[y]; });
    return {years:years, balances:balances};
  }
  function drawFromState(){
    if (!miniChartState.data) return;
    var data = miniChartState.data;
    var base = data.base, ap = data.ap, hasAportes = data.hasAportes, principal = data.principal;
    var c = document.getElementById('miniChart'); if (!c) return;
    var dpr = window.devicePixelRatio || 1;
    var dims = canvasDims(c);
    var cssW = dims.w, cssH = dims.h;
    c.width = Math.round(cssW*dpr); c.height = Math.round(cssH*dpr);
    var ctx = c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);

    var years = base.years.slice();
    if (hasAportes){
      for (var i=0;i<ap.years.length;i++){ if (years.indexOf(ap.years[i])<0) years.push(ap.years[i]); }
    }
    years.sort(function(a,b){return a-b;});

    var maxY = principal;
    for (var i2=0;i2<base.balances.length;i2++){ if (base.balances[i2]>maxY) maxY=base.balances[i2]; }
    if (hasAportes){ for (var i3=0;i3<ap.balances.length;i3++){ if (ap.balances[i3]>maxY) maxY=ap.balances[i3]; } }
    var minY = 0;

    var pad = {L:36, R:10, T:8, B:24};
    var W = cssW - pad.L - pad.R;
    var H = cssH - pad.T - pad.B;
    function xPos(i){ return pad.L + (W * (i/(years.length-1 || 1))); }
    function yScale(v){ return pad.T + H - (H * ((v-minY)/(maxY-minY || 1))); }

    ctx.clearRect(0,0,cssW,cssH);
    ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad.L, pad.T+H); ctx.lineTo(pad.L+W, pad.T+H); ctx.stroke();

    ctx.fillStyle = '#94a3b8'; ctx.font = '11px system-ui';
    function fmt(v){ try{ return new Intl.NumberFormat('es-CR',{style:'currency',currency:'CRC', maximumFractionDigits:0}).format(v);}catch(e){ return '₡'+Math.round(v);} }
    ctx.fillText(fmt(maxY), 4, yScale(maxY)+4);
    ctx.fillText(fmt(0), 4, yScale(0)+4);

    for (var i4=0;i4<years.length;i4++){
      var xx = xPos(i4);
      if (i4===0 || i4===years.length-1 || years.length<=6 || i4%2===0){
        ctx.fillText(String(years[i4]), xx-10, pad.T+H+14);
      }
    }

    // base
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 2; ctx.beginPath();
    for (var b=0;b<base.years.length;b++){
      var yi = years.indexOf(base.years[b]);
      var xx = xPos(yi), yy = yScale(base.balances[b]);
      if (b===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
    }
    ctx.stroke();

    // con aportes
    if (hasAportes){
      ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 2; ctx.beginPath();
      for (var a=0;a<ap.years.length;a++){
        var yi2 = years.indexOf(ap.years[a]);
        var xx2 = xPos(yi2), yy2 = yScale(ap.balances[a]);
        if (a===0) ctx.moveTo(xx2,yy2); else ctx.lineTo(xx2,yy2);
      }
      ctx.stroke();
    }

    var hoverIndex = data.hoverIndex;
    if (hoverIndex!=null && hoverIndex>=0 && hoverIndex<years.length){
      var xxh = xPos(hoverIndex);
      ctx.strokeStyle = '#334155'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(xxh, pad.T); ctx.lineTo(xxh, pad.T+H); ctx.stroke();

      var bi = base.years.indexOf(years[hoverIndex]);
      if (bi>=0){ ctx.fillStyle = '#9ca3af'; ctx.beginPath(); ctx.arc(xxh, yScale(base.balances[bi]), 3, 0, Math.PI*2); ctx.fill(); }
      if (hasAportes){
        var ai = ap.years.indexOf(years[hoverIndex]);
        if (ai>=0){ ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.arc(xxh, yScale(ap.balances[ai]), 3, 0, Math.PI*2); ctx.fill(); }
      }

      var tip = document.getElementById('chartTip');
      var yValBase = (bi>=0)? base.balances[bi] : null;
      var yValAp   = (hasAportes && ap.years.indexOf(years[hoverIndex])>=0) ? ap.balances[ap.years.indexOf(years[hoverIndex])] : null;
      var html = '<b>'+years[hoverIndex]+'</b>';
      if (yValBase!=null) html += '<div class="muted">Base: '+fmt(yValBase)+'</div>';
      if (yValAp!=null)   html += '<div>Con aportes: '+fmt(yValAp)+'</div>';
      tip.innerHTML = html; tip.style.display = 'block';

      var wrap = document.getElementById('curveWrap').getBoundingClientRect();
      var can  = c.getBoundingClientRect();
      var relX = (xxh + can.left) - wrap.left + 8;
      var relY = pad.T + 8;
      tip.style.left = Math.min(Math.max(relX, 8), wrap.width-160) + 'px';
      tip.style.top  = relY + 'px';
    } else {
      var tip2 = document.getElementById('chartTip'); if (tip2) tip2.style.display = 'none';
    }

    miniChartState.data.yearsAxis = years;
    miniChartState.data.xPos = function(i){ return xPos(i); };
  }
  function updateMiniChart(baseRows, aporteRows, startDate, principal, hasAportes){
    var base = curveDataYearly(baseRows, startDate, principal);
    var ap   = curveDataYearly(aporteRows, startDate, principal);
    miniChartState.data = { base:base, ap:ap, startDate:startDate, principal:principal, hasAportes:hasAportes, hoverIndex:null };
    drawFromState();
    requestAnimationFrame(drawFromState);
    if (!window._miniChartResizeBound){
      window.addEventListener('resize', function(){ drawFromState(); });
      window._miniChartResizeBound = true;
    }
    var c = document.getElementById('miniChart');
    if (!c._listenersBound){
      c.addEventListener('mousemove', function(ev){
        if (!miniChartState.data) return;
        var years = miniChartState.data.yearsAxis;
        if (!years || !years.length) return;
        var rect = c.getBoundingClientRect();
        var cssX = ev.clientX - rect.left;
        var idx = 0, best=1e9;
        for (var i=0;i<years.length;i++){
          var xi = miniChartState.data.xPos(i);
          var d  = Math.abs(cssX - xi);
          if (d < best){ best=d; idx=i; }
        }
        miniChartState.data.hoverIndex = idx;
        drawFromState();
      });
      c.addEventListener('mouseleave', function(){
        if (!miniChartState.data) return;
        miniChartState.data.hoverIndex = null;
        drawFromState();
      });
      c._listenersBound = true;
    }
  }

  // --------- Cálculo + render ---------
  function calculateAndRender(){
    if (!allowCalc) { return; }
    var inp = readInputs();
    // calcular cuota inicial y mostrarla
    if (inp.ratePeriods.length && inp.origTerm > 0){
      var r0 = rateAt(inp.startDate, inp.ratePeriods)/12;
      var cuotaIni = (r0>0)
        ? inp.principal * (r0*Math.pow(1+r0, inp.origTerm)) / (Math.pow(1+r0, inp.origTerm)-1)
        : inp.principal / inp.origTerm;
      document.getElementById('monthlyPayment').value = round2(cuotaIni).toFixed(2);
    }

    // Base (sin aportes)
    var base = amortizationSchedule({
      principal: inp.principal, startDate: inp.startDate,
      ratePeriods: inp.ratePeriods, extraEvents: [], recurCfg: null,
      penaltyPct: inp.penaltyPct, penaltyMonths: inp.penaltyMonths, originalTermMonths: inp.origTerm
    });
    summarizeBase('#summaryBase', base.resumen);

    // Con aportes
    var aporte = amortizationSchedule({
      principal: inp.principal, startDate: inp.startDate,
      ratePeriods: inp.ratePeriods, extraEvents: inp.extras, recurCfg: inp.recur,
      penaltyPct: inp.penaltyPct, penaltyMonths: inp.penaltyMonths, originalTermMonths: inp.origTerm
    });
    summarizeAporte('#summaryAporte', aporte.resumen);
    summarizeDiff(base.resumen, aporte.resumen);
    renderSchedule(aporte.rows);

    // Mini chart
    var hasAportes = (inp.extras && inp.extras.length>0) || !!inp.recur;
    updateMiniChart(base.rows, aporte.rows, inp.startDate, inp.principal, hasAportes);

    document.querySelector('#msg').textContent = 'Cálculo actualizado: ' + new Date().toLocaleString();
  }

  // ====== DOM Ready ======
  function onReady(){
    ensureDateInputs();
    var ratesBoxEl = document.getElementById('rates');
    ratesBox = ratesBoxEl;
    extrasList = document.getElementById('extrasList');

    // defaults (sin valores por defecto)
    rateRows = [];
    renderRates();

    // bind events
      document.getElementById('addRate').addEventListener('click', function(e){
        e.preventDefault();
        // preserva valores actuales antes de agregar una fila nueva
        rateRows = readRates();
        var defaultStart = document.getElementById('startDate').value || '';
        if (rateRows.length > 0){
          var prev = rateRows[rateRows.length-1];
          defaultStart = prev.end || prev.start || defaultStart;
        }
        rateRows.push({start: defaultStart, end: null, annual_rate:null});
        renderRates();
      });

    ratesBox.addEventListener('click', function(e){
      var del = e.target && e.target.getAttribute('data-del');
      if (del!==null && del!==undefined){
        // sincroniza valores editados antes de eliminar
        rateRows = readRates();
        var idx = Number(del);
        if (idx>0){ rateRows.splice(idx,1); renderRates(); }
      }
    });

    document.getElementById('startDate').addEventListener('change', function(){
      ensureDateInputs();
    });

    document.getElementById('addExtra').addEventListener('click', function(){
      var d = document.getElementById('exDate').value;
      var a = Number(document.getElementById('exAmount').value);
      var eff = (document.getElementById('exEffect') && document.getElementById('exEffect').value) || 'plazo';
      if (!d || !(a>0)) { alert('Complete fecha y monto > 0'); return; }
      extras.push({date:d, amount:a, mode: eff}); renderExtras();
    });
    extrasList.addEventListener('click', function(e){
      var idx = e.target && e.target.getAttribute('data-del');
      if (idx!==null && idx!==undefined){ extras.splice(Number(idx),1); renderExtras(); }
    });

    // restrict numeric
    ['principal','monthlyPayment','origTerm','exAmount','recurAmount','penaltyPct','penaltyMonths','recurMonths']
    .forEach(function(id){
      var el=document.getElementById(id);
      if (el) {
        el.addEventListener('keydown', function(ev){
          var invalid = ['e','E','+','-']; if (invalid.indexOf(ev.key)>=0) ev.preventDefault();
        });
        el.addEventListener('input', function(){ el.value = el.value.replace(/,/g,'').replace(/\s+/g,''); });
      }
    });

    document.getElementById('calc').addEventListener('click', function(e){
      e.preventDefault();
      try{ allowCalc = true; calculateAndRender(); }catch(err){ document.getElementById('msg').textContent = err.message || String(err); }
    });

    document.getElementById('exportCsv').addEventListener('click', function(){
      var tb = document.querySelector('#sched tbody');
      if (!tb.children.length){ alert('Primero ejecutá el cálculo.'); return; }
      try{
        var inp = readInputs();
        var aporte = amortizationSchedule({
          principal: inp.principal, startDate: inp.startDate,
          ratePeriods: inp.ratePeriods, extraEvents: inp.extras, recurCfg: inp.recur,
          penaltyPct: inp.penaltyPct, penaltyMonths: inp.penaltyMonths, originalTermMonths: inp.origTerm
        });
        var header = ["Periodo","FechaPago","TasaAnual(%)","Interes","Amortizacion","Cuota","Penalidad","AportesExtra","SaldoFinal"];
        var lines = [header.join(",")];
        for (var i=0;i<aporte.rows.length;i++){
          var r = aporte.rows[i];
          lines.push([r.Periodo,r.FechaPago,r.TasaAnualPeriodo.toFixed(4),r.Interes,r.Amortizacion,r.Cuota,r.Penalidad,r.AportesExtra,r.SaldoFinal].join(","));
        }
        var csv = lines.join("\n");
        var blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a'); a.href=url; a.download='cronograma_aporte.csv';
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      }catch(err){ alert(err.message||String(err)); }
    });

    // Primer cálculo/curva
    try{ calculateAndRender(); }catch(e){ document.getElementById('msg').textContent = e.message || String(e); }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', onReady);
  } else {
    onReady();
  }
})();
</script>
</body>
</html>
